<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Table Of Contents &mdash; Unify Host SDK</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom_styles.css" type="text/css" />
    <link rel="canonical" href="https://siliconlabs.github.io/UnifySDK/applications/zigpc/Getting_Started.html" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/js/charenc.js"></script>
        <script src="../../_static/js/crypt.js"></script>
        <script src="../../_static/js/sha1.js"></script>
        <script src="../../_static/js/html5-qrcode.min.js"></script>
        <script src="../../_static/js/qr_code_scanner.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../doc/introduction.html" class="icon icon-home"> Unify
            <img src="../../_static/silicon-labs-logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                ver_1.3.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../doc/introduction.html">Unify Host SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/UnifySDK.html">Unify Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/multiprotocol.html">Multiprotocol Host Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/getting_started.html">Getting Started with the Unify Host SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/readme_developer.html">Unify Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/system_requirements.html">System Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/qr_code_scanner.html">QR-Code Scanner</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc/license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../doc/introduction.html">Unify</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <script>
    $(".wy-side-scroll").append("<div class='github-button'><iframe src='https://ghbtns.com/github-btn.html?user=SiliconLabs&repo=UnifySDK&type=watch&count=true&size=large&v=2' allowtransparency='true' frameborder='0' scrolling='0' width='170' height='30'></iframe></div>");
</script>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="table-of-contents">
<h1>Table Of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this heading"></a></h1>
<ul class="simple">
<li><p><span class="xref myst">Table Of Contents</span></p></li>
<li><p><span class="xref myst">Preparing Hardware</span></p></li>
<li><p><span class="xref myst">Preparing the OS and installing required tools</span></p></li>
<li><p><span class="xref myst">Getting the source code on the devices</span></p></li>
<li><p><span class="xref myst">Docker Setup</span></p></li>
<li><p><span class="xref myst">Raspberry Pi Setup</span></p></li>
<li><p><span class="xref myst">Compiling code for the Raspberry Pi</span></p></li>
<li><p><span class="xref myst">Getting the NCP WSTK going :</span></p></li>
<li><p><span class="xref myst">Debugging with visual studio code, Cleaning the code</span></p></li>
</ul>
<section id="preparing-hardware">
<h2>Preparing Hardware<a class="headerlink" href="#preparing-hardware" title="Permalink to this heading"></a></h2>
<p>For this guide you need :</p>
<ul class="simple">
<li><p>2 WSTK with BRD4163A radios</p></li>
<li><p>1 Raspberry Pi (3B+ or 4)</p></li>
<li><p>1 Network switch</p></li>
</ul>
</section>
<section id="preparing-the-os-and-installing-required-tools">
<h2>Preparing the OS and installing required tools<a class="headerlink" href="#preparing-the-os-and-installing-required-tools" title="Permalink to this heading"></a></h2>
<p>Easy to install tools :</p>
<ul class="simple">
<li><p>Git</p></li>
<li><p>Visual Studio Code</p></li>
<li><p>Raspberry Pi Imager : <a class="reference external" href="https://www.raspberrypi.com/software/">https://www.raspberrypi.com/software/</a></p></li>
<li><p>Simplicity Studio 5 : <a class="reference external" href="https://www.silabs.com/developers/simplicity-studio">https://www.silabs.com/developers/simplicity-studio</a></p></li>
<li><p>Docker : <a class="reference external" href="https://www.docker.com/">https://www.docker.com/</a></p></li>
<li><p>GDB - might require specific steps for macos : see <a class="reference external" href="https://gist.github.com/gravitylow/fb595186ce6068537a6e9da6d8b5b96d">https://gist.github.com/gravitylow/fb595186ce6068537a6e9da6d8b5b96d</a> to sign gdb</p></li>
<li><p>MQTT Explorer : <a class="reference external" href="https://mqtt-explorer.com/">https://mqtt-explorer.com/</a></p></li>
<li><p>Nice to have : FileZila VNC Viewer</p></li>
</ul>
</section>
<section id="getting-the-source-code-on-the-devices">
<h2>Getting the source code on the devices<a class="headerlink" href="#getting-the-source-code-on-the-devices" title="Permalink to this heading"></a></h2>
<p>Clone the unify git repo :</p>
<p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">https://github.com/SiliconLabs/UnifySDK.git</span></code></p>
<p>Initialise the git submodules of the repo :
<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">update</span> <span class="pre">--init</span> <span class="pre">--recursive</span></code></p>
<p>Get a copy of the GSDK</p>
<p><a class="reference external" href="https://github.com/SiliconLabs/gecko_sdk">github.com/SiliconLabs/gecko_sdk</a></p>
<p>public repo :</p>
<p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">https://github.com/SiliconLabs/gecko_sdk</span></code></p>
<p>You need to add the GSDK location to your environment variable GSDK_LOCATION</p>
<p>See also : Specific build instruction /projects/UIC/repos/uic/browse/doc/build_instructions.internal.md</p>
</section>
<section id="docker-setup">
<h2>Docker Setup<a class="headerlink" href="#docker-setup" title="Permalink to this heading"></a></h2>
<p>After having installed docker desktop</p>
<p>To build and cross compile stuff ( inside host shell )</p>
<p>From the uic repository /docker folder :
To create new container for specific architectures :
<code class="docutils literal notranslate"><span class="pre">./build_docker.sh</span> <span class="pre">&lt;architecture&gt;</span> <span class="pre">&lt;container_name&gt;</span></code>
EX : For the Pi
    <code class="docutils literal notranslate"><span class="pre">./build_docker.sh</span> <span class="pre">arm64</span> <span class="pre">uic_arm64</span></code>
Ex : To run unit test 
    <code class="docutils literal notranslate"><span class="pre">./build_docker.sh</span> <span class="pre">amd64</span> <span class="pre">uic_amd64</span></code></p>
<p>Once the docker script is done : From the uic root folder run :</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--env<span class="w"> </span>GSDK_LOCATION<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-v<span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>:<span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-w<span class="w"> </span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-v<span class="w"> </span><span class="si">${</span><span class="nv">GSDK_LOCATION</span><span class="si">}</span>:<span class="si">${</span><span class="nv">GSDK_LOCATION</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>uic_arm64
</pre></div>
</div>
</section>
<section id="raspberry-pi-setup">
<h2>Raspberry Pi Setup<a class="headerlink" href="#raspberry-pi-setup" title="Permalink to this heading"></a></h2>
<p>Using the Raspberry Pi Imager, select the latest 64 bit Rasbian OS.
In advanced options of the Imager (Click the gear icon after selecting the OS), enable ssh, set username and password, hostname, enable wifi.</p>
<p>Add mosquitto to the system:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">$sudo</span><span class="w"> </span>apt<span class="w"> </span>update
<span class="nv">$sudo</span><span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>mosquitto<span class="w"> </span>mosquitto-clients<span class="sb">`</span>
</pre></div>
</div>
<p>Install the packages from latest release :</p>
<p>Get the latest packages from the develop branch  :</p>
<p><a class="reference external" href="https://github.com/SiliconLabs/UnifySDK/releases">https://github.com/SiliconLabs/UnifySDK/releases</a></p>
<p>Install them using (change name as required ) :</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>dpkg<span class="w"> </span>-i<span class="w"> </span>uic-dev-gui_*_arm64.deb<span class="w"> </span>uic-gms_*_arm64.deb<span class="w"> </span>uic-image-provider_*_arm64.deb<span class="w"> </span>uic-upvl_*_arm64.deb<span class="w"> </span>uic-zigpc_*_arm64.deb
</pre></div>
</div>
<p>See user guide for more info : /projects/UIC/repos/uic/browse/doc/readme_user.md</p>
<p>For future MQTT Explorer use, add those lines to /etc/mosquitto/mosquitto.conf</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>listener<span class="w"> </span><span class="m">1883</span>
allow_anonymous<span class="w"> </span><span class="nb">true</span>
</pre></div>
</div>
</section>
<section id="compiling-code-for-the-raspberry-pi">
<h2>Compiling code for the Raspberry Pi<a class="headerlink" href="#compiling-code-for-the-raspberry-pi" title="Permalink to this heading"></a></h2>
<p>On the development computer :</p>
<p>Go back to uic folder and enter your docker container using the previous docker run command (See <span class="xref myst">Docker Setup</span>).
Set up the cmake build folder using :</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>build
<span class="nb">cd</span><span class="w"> </span>build
cmake<span class="w"> </span>-GNinja<span class="w"> </span>-DCMAKE_TOOLCHAIN_FILE<span class="o">=</span>../cmake/arm64_debian.cmake<span class="w"> </span>-DBUILD_ZPC<span class="o">=</span>OFF<span class="w"> </span>-DCMAKE_BUILD_TYPE<span class="o">=</span>Debug<span class="w"> </span>..
ninja<span class="w">               </span><span class="c1"># Build binaries</span>
ninja<span class="w"> </span>doxygen<span class="w">       </span><span class="c1"># Build doxygen documentation (optional)</span>
ninja<span class="w"> </span>deb<span class="w">           </span><span class="c1"># Build Debian Installers (optional)</span>
</pre></div>
</div>
<p>Notice that this is telling cmake to use the specific target architecture ( arm64 ) toolchain and to enable debug symbol for future debugging.</p>
<p>If you want to reduce build time, you can specifically build a specific component :</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>ninja<span class="w"> </span>zigpc<span class="w"> </span><span class="c1">#Builds zigpc application</span>
</pre></div>
</div>
</section>
<section id="getting-the-ncp-wstk-going">
<h2>Getting the NCP WSTK going :<a class="headerlink" href="#getting-the-ncp-wstk-going" title="Permalink to this heading"></a></h2>
<p>Since Simplicity Studio adds time to this process, we will try to skip its usage. Be aware that you can generate new firmware with specific cluster using Simplicity Studio or by modifying the slcp file and then generating using the slc tool.</p>
<p>Thus, we will use the slc command line tool to create the firmware for the ncp.</p>
<p>Related user guide : <a class="reference external" href="https://www.silabs.com/documents/public/user-guides/ug520-software-project-generation-configuration-with-slc-cli.pdf">https://www.silabs.com/documents/public/user-guides/ug520-software-project-generation-configuration-with-slc-cli.pdf</a></p>
<p>Follow the user guide installation process in order to install the tool, then add the slc folder to your system environment path.</p>
<p>You can find Zigbee sample apps for the ncp in the Gecko SDK folder under gecko-sdk/protocol/zigbee/app/ncp/sample-app/ncp-uart-hw</p>
<p>The Boatloader is under gecko-sdk/platform/bootloader/sample-apps/bootloader-storage-spiflash</p>
<p>In order to get the .s37 executable for the boatloader and the zigbee application :</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>slc<span class="w"> </span>generate<span class="w"> </span>ncp-uart-hw.slcp<span class="w"> </span>--with<span class="w"> </span>&lt;BOARD_IDENTIFIER&gt;<span class="w"> </span>-np<span class="w"> </span>-d<span class="w"> </span>output/cd<span class="w"> </span>output
make<span class="w"> </span>-f<span class="w"> </span>ncp-uart-hw.Makefile
</pre></div>
</div>
<p>Example board identifier
Thunderboard sense 2  : brd4166a</p>
<blockquote>
<div><p>Note : To synchronise the device and the gateway address table. add under define in the &lt;NCP-NAME&gt;.slcp</p>
</div></blockquote>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="w">  </span>-<span class="w"> </span>name:<span class="w"> </span><span class="s2">&quot;EMBER_ADDRESS_TABLE_SIZE&quot;</span>
<span class="w">    </span>value:<span class="w"> </span><span class="s2">&quot;32&quot;</span>
</pre></div>
</div>
<p>This value must match EMBER_AF_PLUGIN_ADDRESS_TABLE_SIZE in zigpc/components/zigpc_gateway/libs/zigbee_host/gen/config</p>
<p>Once you have both .s37 files, flash using simplicity commander / simplicity studio</p>
<p>###Troubleshooting NCP issues and versioning</p>
<p>There are some common issues faced when updating to a new version of ZigPC or
a new version of the GeckoSDK</p>
<section id="issue-1-ncp-and-gateway-mismatch">
<h3>Issue #1: NCP and Gateway mismatch<a class="headerlink" href="#issue-1-ncp-and-gateway-mismatch" title="Permalink to this heading"></a></h3>
<p>After upgrading, it is possible to see ZigPC fail to start with the error:</p>
<blockquote>
<div><p>ERROR: ezspErrorHandler 0x30</p>
</div></blockquote>
<p>Or an equivalent error.</p>
<p>Usually this occurs because the version of the GeckoSDK on the gateway and the
version on the NCP do not match. It’s important that version matches so that the
EZSP communication libraries are the same on both the host and the radio.</p>
<p>This issue can be resolved in 2 ways: downgrading the version of the GeckoSDK to
match with the NCP or updating the NCP firmware to match the gateway.</p>
<p>To change the version of the GeckoSDK used by the gateway, download the desired
version of the GeckoSDK and keep note of the directory it is stored in. By
default, the provided Docker container downloads the latest version to the
‘externals’ folder in the uic project. This can be overridden by setting the
“GSDK_LOCATION” environment variable with the new GeckoSDK and re-compiling the
ZigPC gateway.</p>
<p>To update the NCP firmware, re-generate the firmware as described above with the
matching version of the GeckoSDK. If you have hardware access, re-flash the NCP
as usual. However, if only remote access is possible, ZigPC can be used to
update the NCP firmware as described in the User Guide (section ‘Updating NCP
Firmware’</p>
<p>####Issue #2: addressTable mismatch</p>
<p>When running the ZigPC, its possible for the gateway to fail to start with an
error describing:</p>
<blockquote>
<div><p>ASSERT addressTableSize mismatch</p>
</div></blockquote>
<p>or a similar error.</p>
<p>Usually, this occurs because the address table size was not properly set in the
NCP. Some information is shared between the gateway and the NCP, specifically
related to the network information. In this case, the address table is used to
resolve the global EUI64 with the short ID commonly used on zigbee networks. The
size of these tables should match on both the gateway and NCP to ensure that no
data is lost when handling too many devices.</p>
<p>There are two ways of solving this: reducing the address table on the gateway or
increasing the address table size on the NCP.</p>
<p>The recommended method is to increase the address table size on the NCP. This
can be done by adding the “EMBER_ADDRESS_TABLE_SIZE” to the .slcp file, as
described in the section above. Alternatively, add a definition to the NCP
makefile setting the above define. Compiling with -DEMBER_ADDRESS_TABLE_SIZE=
32 will also work.</p>
<p>It is possible to solve this by reducing EMBER_AF_ADDRESS_TABLE_SIZE on the
gateway, however this is NOT recommended as it can reduce the number of devices
that ZigPC will support</p>
</section>
</section>
<section id="debugging-with-visual-studio-code-cleaning-the-code">
<h2>Debugging with visual studio code, Cleaning the code<a class="headerlink" href="#debugging-with-visual-studio-code-cleaning-the-code" title="Permalink to this heading"></a></h2>
<p>From phase 6 you should now have the ability to generate custom zigpc executables.</p>
<p>Transfer them to the pi using FileZila or scp.</p>
<p>make sure that no uic-zigpc from previously installed package are running using (use killall if need be)</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>uic-zigpc
chmod<span class="w"> </span>+x<span class="w"> </span>./zigpc
sudo<span class="w"> </span>./zigpc
</pre></div>
</div>
<blockquote>
<div><p>Note : zigpc should not usually be runned as superuser. There is currently a bug in datastore that forces this issue.</p>
</div></blockquote>
<p>You should now be able to access the devgui of the gateway under raspberrypi.local:3080</p>
<p>For more information about the devgui see : /projects/UIC/repos/uic/browse/applications/dev_ui/dev_gui/readme_user.md</p>
<p>Debugging using visual studio code :
Install native debug extension : <a class="reference external" href="https://marketplace.visualstudio.com/items?itemName=webfreak.debug">https://marketplace.visualstudio.com/items?itemName=webfreak.debug</a></p>
<p>Create a code workspace containing both the Gecko SDK folder and the UIC folder</p>
<p>As the Launch.json use :</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;configurations&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;gdb&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;request&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;attach&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Extended remote raspberrypi&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;executable&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;PATH_TO_UIC/uic/build/applications/zigpc/zigpc&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;target&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;extended-remote raspberrypi.local:2000&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;remote&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;cwd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;${workspaceRoot}&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;valuesFormatting&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;parseText&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;stopAtConnect&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>On the Pi install gdbserver</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>gdbserver
<span class="c1">#Run ZigPc on GDBserver</span>
sudo<span class="w"> </span>gdbserver<span class="w"> </span>localhost:2000<span class="w"> </span>./zigpc
</pre></div>
</div>
<p>Cleaning the code :
To clang format in zigpc (Modify path as needed)</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>find<span class="w"> </span>../applications/zigpc/components<span class="w"> </span>-iname<span class="w"> </span><span class="s2">&quot;*.c&quot;</span><span class="w"> </span>-o<span class="w"> </span>-iname<span class="w"> </span><span class="s2">&quot;*.h&quot;</span><span class="w"> </span>-o<span class="w"> </span>-iname<span class="w"> </span><span class="s2">&quot;*.cpp&quot;</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>clang-format-10<span class="w"> </span>-i
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>
    <hr/>
    <p>Copyright © 2023 Silicon Laboratories. All rights reserved.</p>
</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>