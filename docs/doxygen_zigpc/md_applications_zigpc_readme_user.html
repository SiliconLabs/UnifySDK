<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Zigbee Protocol Controller: ZigPC User&#39;s Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Zigbee Protocol Controller
   &#160;<span id="projectnumber">1.2.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_applications_zigpc_readme_user.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">ZigPC User's Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document is a user guide for the Zigbee Protocol controller (ZigPC). The primary role of ZigPC is to allow Zigbee devices to be monitored and controlled using the Unify Controller Language (UCL).</p>
<p><br  />
<br  />
</p>
<h1><a class="anchor" id="autotoc_md30"></a>
Overview</h1>
<p>The Unify Framework provides a consolidated API to observe and control devices that communicate using different sensor network protocols (Zigbee, Z-Wave, and so on) with the help of Unify Protocol Controllers.</p>
<p>An MQTT broker is at the core of Unify Framework. It is used by Protocol Controllers to send and receive commands and information from other Unify components using the Unify Controller Language (UCL).</p>
<p>The Zigbee Protocol Controller (ZigPC) is an opinionated Zigbee gateway that act as a Unify gateway, as specified in the Unify Specification.</p>
<p>ZigPC uses the Zigbee Host-NCP model to relay messages from Unify to the end device where EZSP is used as the serial protocol to communicate with the NCP.</p>
<p><br  />
<br  />
</p>
<h1><a class="anchor" id="autotoc_md31"></a>
Hardware Prerequisites</h1>
<p>Running Unify with ZigPC requires the following equipment:</p>
<h2><a class="anchor" id="autotoc_md32"></a>
Gateway Host Device: Raspberry Pi</h2>
<p>ZigPC is officially supported on a Raspberry Pi 4 running Debian Buster (A.K.A. Raspberry Pi OS).</p>
<p>For installation and setup, follow steps outlined in: <a href="https://www.raspberrypi.org/documentation/">https://www.raspberrypi.org/documentation/</a></p>
<p>Find more information about Raspberry Pi OS here: <a href="https://www.raspberrypi.org/downloads/raspberry-pi-os/">https://www.raspberrypi.org/downloads/raspberry-pi-os/</a></p>
<h2><a class="anchor" id="autotoc_md33"></a>
Gateway NCP Device</h2>
<p>Supported radios: EFR32MG1X or EFR32MG2X Supported EZSP protocol: UART (SPI not officially supported)</p>
<h2><a class="anchor" id="autotoc_md34"></a>
PAN Zigbee Device</h2>
<p>Currently supported Zigbee device provisioning methods:</p>
<ul>
<li>Zigbee 3.0 with Install Code</li>
<li>Zigbee 3.0 with Well-Known-Key</li>
</ul>
<p>See the Appendix section at the bottom of the guide for steps to configure example NCP and Z3Light device FW images.</p>
<p><br  />
<br  />
</p>
<h1><a class="anchor" id="autotoc_md35"></a>
Installing ZigPC</h1>
<p>All of the Unify components below (MQTT Broker, UPVL client and GMS client) should be installed before running the ZigPC. Running Unify with ZigPC requires using an MQTT Broker. Unify currently supports using Mosquitto MQTT (<a href="https://mosquitto.org/">https://mosquitto.org/</a>).</p>
<p>For installing please refer to the general installation method in Getting started.</p>
<h2><a class="anchor" id="autotoc_md36"></a>
Description of Installed Components</h2>
<p>After the packages are installed, the following services and libraries are available on the Raspberry Pi:</p>
<h3><a class="anchor" id="autotoc_md37"></a>
Mosquitto MQTT System Service</h3>
<p>The Mosquitto MQTT broker is installed as a system service running in the background. It should be started before attempting to launch any Unify component. Otherwise, Unify components may not launch properly and may not communicate to each other properly.</p>
<h3><a class="anchor" id="autotoc_md38"></a>
Mosquitto MQTT Clients: mosquitto_pub, mosquitto_sub</h3>
<p>The Mosquitto publish &amp; subscribe tools can be used to interact with the Unify MQTT broker by providing a topic and a message payload (if publishing).</p>
<h3><a class="anchor" id="autotoc_md39"></a>
libuic.so</h3>
<p>This library contains the runtime dependencies used by some Unify components (including ZigPC). See Unify Framework Library Developer Guide for more details.</p>
<h3><a class="anchor" id="autotoc_md40"></a>
uic-upvl</h3>
<p>The Unify Framework Provisioning List (UPVL) maintains the UCL SmartStart topics (and its List, Update, and Remove subtopics. See UPVL User Guide for more details.</p>
<h3><a class="anchor" id="autotoc_md41"></a>
uic-gms</h3>
<p>Unify IoT service that book-keeps groups data among different Protocol Controllers. It manages the ucl/by-group/# topic space. See GMS User Guide for more details.</p>
<h3><a class="anchor" id="autotoc_md42"></a>
uic-image-provider</h3>
<p>Unify IoT service that stores and distributes OTA Firmware images for Protocol Controllers over UCL. It manages the ucl/OTA/# topic space. See Image Provider User's Guide for more details.</p>
<h3><a class="anchor" id="autotoc_md43"></a>
zigpc</h3>
<p>The Zigbee Protocol Controller application connects to the Mosquitto MQTT broker, sets up a PAN as a Zigbee Coordinator, and relays messages using the Zigbee NCP connected on a serial port.</p>
<p><br  />
<br  />
</p>
<h1><a class="anchor" id="autotoc_md44"></a>
Starting ZigPC on the Command Line</h1>
<ol type="1">
<li>Run the MQTT Broker on the Raspberry Pi.</li>
</ol>
<div class="fragment"><div class="line">systemctl start mosquitto</div>
<div class="line">systemctl status mosquitto</div>
<div class="line"> </div>
<div class="line"># If you encounter problems with running the service, logs can be received by running</div>
<div class="line">journalctl -u mosquitto</div>
</div><!-- fragment --><ol type="1">
<li>Run the UPVL application on the Raspberry Pi by following instructions in the UPVL User Guide.</li>
</ol>
<div class="fragment"><div class="line"># Make sure uic-upvl is running</div>
<div class="line">sudo systemctl status uic-upvl</div>
<div class="line"> </div>
<div class="line"># NOTE: If it has stopped or not running, run the following commands:</div>
<div class="line">#     sudo systemctl enable uic-upvl</div>
<div class="line">#     sudo systemctl start uic-upvl</div>
</div><!-- fragment --><ol type="1">
<li>Run the Group Management Service application on the Raspberry Pi by following instructions in the GMS User Guide.</li>
</ol>
<div class="fragment"><div class="line"># Make sure uic-gms is running</div>
<div class="line">sudo systemctl status uic-gms</div>
<div class="line"> </div>
<div class="line"># NOTE: If it has stopped or not running, run the following commands:</div>
<div class="line">#     sudo systemctl enable uic-gms</div>
<div class="line">#     sudo systemctl start uic-gms</div>
</div><!-- fragment --><ol type="1">
<li>Run the Image provider application on the Raspberry Pi by following instructions in the Image Provider User Guide.</li>
</ol>
<div class="fragment"><div class="line"># Make sure uic-image-provider is running</div>
<div class="line">sudo systemctl status uic-image-provider</div>
<div class="line"> </div>
<div class="line"># NOTE: If it has stopped or not running, run the following commands:</div>
<div class="line">#     sudo systemctl enable uic-image-provider</div>
<div class="line">#     sudo systemctl start uic-image-provider</div>
</div><!-- fragment --><ol type="1">
<li>Run ZigPC on the Raspberry Pi with the serial port to the flashed Zigbee NCP. <b>Running ZigPC as a system service</b> Once installed, ZigPC will be configured to run as a system service by default.</li>
</ol>
<div class="fragment"><div class="line"># Make sure uic-zigpc is running</div>
<div class="line">sudo systemctl status uic-zigpc</div>
<div class="line"> </div>
<div class="line"># NOTE: If it has stopped or not running, run the following commands:</div>
<div class="line">#     sudo systemctl enable uic-zigpc</div>
<div class="line">#     sudo systemctl start uic-zigpc</div>
<div class="line"> </div>
<div class="line"># NOTE: To stop running zigpc as a system service, run the following commands:</div>
<div class="line">#     sudo systemctl stop uic-zigpc</div>
<div class="line">#     sudo systemctl disable uic-zigpc</div>
</div><!-- fragment --><p>The configuration used by the service can be found at <code>etc/uic/uic.cfg</code></p>
<p><b>Running ZigPC on the command line</b> If ZigPC is not running a system service</p>
<div class="fragment"><div class="line">zigpc --zigpc.serial /dev/ttyACM0 --mqtt.host 0.0.0.0 --mqtt.port 1883 --zigpc.datastore_file zigpc.db</div>
</div><!-- fragment --><blockquote class="doxtable">
<p><em>NOTE: Run <code>zigpc --help</code> to see a full list of supported parameters</em> </p>
</blockquote>
<blockquote class="doxtable">
<p><em>NOTE: ZigPC serial argument point to the UART-EZSP port exposed by the Zigbee NCP. This path will be different based on the configuration of tty devices connected to your Raspberry Pi</em> </p>
</blockquote>
<blockquote class="doxtable">
<p><em>NOTE: Ensure ZigPC is only running as a system service or via the CLI and not both</em> </p>
</blockquote>
<p><br  />
<br  />
</p>
<h1><a class="anchor" id="autotoc_md45"></a>
Using ZigPC in a multiprotocol configuration</h1>
<p>The ZigPC is an EZSP-based gateway application and can be run in a multiprotocol environment. Please see Multiprotocol Setup for details about the multiprotocol stack.</p>
<p>In summary, the radio should be configured as an RCP, as opposed to a standard Zigbee NCP. The CPCd application should run and point to the RCP. If encryption is enabled, please follow the guide above, but the encryption key will need to be flashed to the radio.</p>
<p>Once properly setup, Zigbeed is required to run. By default, it points to the 1st CPCd radio URL. If installing Zigbeed through Unify, a port will be opened at /dev/ttyZigbeeNCP which will forward all EZSP messages to the Zigbeed application.</p>
<p>After Zigbeed and CPCd are both properly set up, ZigPC can then be started and used in a multiprotocol context by pointing '&ndash;zigpc.serial' at the virtual USB port (/dev/ttyZigbeeNCP) created in the previous step.</p>
<p>The user can then configure the other protocols alongside ZigPC to run many protocols using the same radio.</p>
<h2><a class="anchor" id="autotoc_md46"></a>
NOTE</h2>
<pre class="fragment">By default, the ZigPC is configured for a singe protocol environment
Therefore, the ZigPC will point to the same USB port as the CPCd
application.
When running ZigPC in a multiprotocol context, the serial port should be
changed to avoid this conflict.
</pre><h1><a class="anchor" id="autotoc_md47"></a>
Understanding ZigPC Functions</h1>
<p>The Zigbee Protocol Controller performs network discovery and device servicing for sleepy and non-sleepy Zigbee devices. The following section outline some of the different functions ZigPC performs.</p>
<h2><a class="anchor" id="autotoc_md48"></a>
Device Addressing</h2>
<p>Unify uses a unique identifier when addressing nodes included by different protocol controllers called a Unified Node Identifier (UNID). ZigPC uses the Extended Unique Identifier of the device (EUI64) as part of the UNID to relay messages between Unify and Zigbee devices: <code>zb-&lt;EUI64_IN_BIG_ENDIAN&gt;</code></p>
<p>For example, if the EUI64 of a device is <code>00-11-22-33-44-55-66-77</code>, the UNID will be: <code>zb-0011223344556677</code></p>
<h2><a class="anchor" id="autotoc_md49"></a>
Zigbee Node Commissioning</h2>
<p>ZigPC currently only supports adding Zigbee devices using the Unify SmartStart List functionality. The currently supported format recognized by ZigPC is the Z3 Install Codes based Device-Specific key (DSK). See Unify Specification Section 3.7.1 for more details.</p>
<h3><a class="anchor" id="autotoc_md50"></a>
Z3 Install Code-Based Provisioning</h3>
<p>The Unify SmartStart List enables easily adding pre-provisioned devices to the network using a protocol-specific Device-Specific Key (DSK). The SmartStart List is managed by another Unify component called uic-upvl.</p>
<p>Currently, ZigPC uses DSKs that contain information from the out-of-band Zigbee 3.0 Installation Code method to permit a Zigbee device to join the network.</p>
<p><b>DSK Format:</b></p>
<p>ZigPC Accepts SmartStart entries that have the following DSK format in groups of two hexadecimal values:</p>
<div class="fragment"><div class="line">&lt;END_DEVICE_EUI64&gt;-&lt;END_DEVICE_INSTALL_CODE&gt;-&lt;END_DEVICE_INSTALL_CODE_CRC&gt;</div>
</div><!-- fragment --><p>For example, if the Zigbee device EUI64 (big endian) is 0x00 0xAA 0x11 0xBB 0x22 0xCC 0x33 0xDD and the install code (big endian) is 0x0A 0x0B 0x0C 0x0D 0xE 0xF 0x1 0x2 with a CRC of 0x7B8A, the DSK should be:</p>
<div class="fragment"><div class="line">00-AA-11-BB-22-CC-33-DD-0A-0B-0C-0D-0E-0F-01-02-7B-8A</div>
</div><!-- fragment --><p>After a Z3 Install code-based SmartStart DSK has been recognized in the Unify published SmartStart List, ZigPC will extract and add the Install Code and EUI64 pair to ZigPC. When network-steering is performed on the joining node, ZigPC will validate using the Install Code based Link key extracted and allow the device to join the network.</p>
<p>See (AN1089: Using Installation Codes with Zigbee Devices)[<a href="https://www.silabs.com/documents/public/application-notes/an1089-using-installation-codes-with-zigbee-devices.pdf">https://www.silabs.com/documents/public/application-notes/an1089-using-installation-codes-with-zigbee-devices.pdf</a>] for more details on how to setup Z3 Install Codes on joining devices.</p>
<p>UCL topics used:</p>
<ul>
<li>Subscribing to the current list of SmartStart entries: <code>ucl/SmartStart/List</code></li>
</ul>
<h3><a class="anchor" id="autotoc_md51"></a>
Well-Known-Key Based Provisioning</h3>
<p>The ZigPC network can be configured to accept device joins using the well-known key. ZigPC will open up the network and allow well-known key based joins when the NetworkManagement state <code>add node</code> is requested:</p>
<p>UCL topics used:</p>
<ul>
<li>Subscribing to Network Management state change requests: <code>ucl/by-unid/&lt;DEVICE_UNID&gt;/ProtocolController/NetworkManagement/Write</code></li>
<li>Publishing Network Management state changes: <code>ucl/by-unid/&lt;DEVICE_UNID&gt;/ProtocolController/NetworkManagement</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md52"></a>
Device State Updates</h2>
<p>ZigPC publishes the network status of devices through inclusion, interview, and regular function stages.</p>
<p>UCL topics used:</p>
<ul>
<li>Publishing device state updates: <code>ucl/by-unid/&lt;DEVICE_UNID&gt;/State</code></li>
<li>Publishing endpoints active under device: <code>ucl/by-unid/&lt;DEVICE_UNID&gt;/State/Attributes/EndpointIdList/Reported</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md53"></a>
Device Discovery</h2>
<p>Once added to the network, ZigPC performs device interviewing to retrieve the ZCL clusters supported per each endpoint on the device. After the device interview process finishes, bindings and attribute reports are configured to publish attribute updates to Unify. In addition, ZigPC publishes the commands supported by these ZCL clusters as UCL clusters.</p>
<p>UCL topics used:</p>
<ul>
<li>Publishing supported commands for UCL clusters discovered: <code>ucl/by-unid/&lt;DEVICE_UNID&gt;/ep&lt;ENDPOINT_ID&gt;/&lt;CLUSTER_NAME&gt;/SupportedCommands</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md54"></a>
Device Command Relaying</h2>
<p>After the supported commands are published by ZigPC for a device endpoint, UCL commands can be sent to the Zigbee device. The UCL command received by ZigPC is mapped to a corresponding ZCL command and sent to the Zigbee device endpoint.</p>
<p>UCL topics used:</p>
<ul>
<li>Subscribing to UCL cluster commands sent by Unify gateway: <code>ucl/by-unid/&lt;DEVICE_UNID&gt;/ep&lt;ENDPOINT_ID&gt;/&lt;CLUSTER_NAME&gt;/Commands/&lt;COMMAND_NAME&gt;</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md55"></a>
Device GeneratedCommand Updates</h2>
<p>ZigPC is able to publish commands generated by devices (either as command responses or as unsolicted stimuli) to the Unify broer. The ZCL command is parsed and mapped to UCL command before publishing under the device, endpoint, cluster combination.</p>
<p>UCL topics used:</p>
<ul>
<li>Publishing to UCL cluster generated commands received to Unify gateway: <code>ucl/by-unid/&lt;DEVICE_UNID&gt;/ep&lt;ENDPOINT_ID&gt;/&lt;CLUSTER_NAME&gt;/GeneratedCommands/&lt;COMMAND_NAME&gt;</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md56"></a>
Device Attribute Updates</h2>
<p>Zigbee devices with attribute reporting configured will send ZigPC attribute reports for each attribute supported in each ZCL cluster under each endpoint. These attribute updates are published under the UCL <code>Reported</code> topic when changes occur of after a timeout.</p>
<p>UCL topics used:</p>
<ul>
<li>Publishing reported UCL cluster attribute updates: <code>ucl/by-unid/&lt;DEVICE_UNID&gt;/ep&lt;ENDPOINT_ID&gt;/&lt;CLUSTER_NAME&gt;/Attributes/&lt;ATTRIBUTE_NAME&gt;/Reported</code></li>
</ul>
<p>To disable bindings and reporting between end devices and the protocol controller, run zigpc with the '&ndash;zigpc.poll_attr_only' flag at runtime. This flag forces the protocol controller to poll endpoints using a 'ReadAttributes' command at a set interval (500ms by default). In this configuration, sending a 'ForceReadAttributes' MQTT message can also request the specific attributes desired from an endpoint.</p>
<h2><a class="anchor" id="autotoc_md57"></a>
Group Message Handling</h2>
<p>Unify uses the ZCL Group ID format to send group commands to multiple devices spanning different protocols at the same time. ZigPC uses the ZCL Groups cluster functionality on each Zigbee endpoint to maintain the group membership. After an endpoint is added to the group using the UCL Groups/AddGroup command, ZigPC publishes the list of groups the endpoint is part of.</p>
<p>ZigPC uses the functionality provided by the Unify Group manager component called uic-gms. Once the group list is published by ZigPC, the uic-gms manages the group commands that can be sent through the Unify gateway.</p>
<p>ZigPC listens to the by-group topic space and services any groupIDs that is recognized by translating the UCL cluster command and sending this message as a multicast message to the Zigbee network.</p>
<p>UCL topics used:</p>
<ul>
<li><code>ucl/by-group/&lt;GROUP_ID&gt;/&lt;CLUSTER_NAME&gt;/Commands/&lt;COMMAND_NAME&gt;</code><ul>
<li>Behavior: ZigPC listens to DotDot cluster commands received and sends the group command as a multicast message on the network based on Unify Spec Section 6.3.3.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md58"></a>
Zigbee OTA Firmware Upgrade Support</h2>
<p>ZigPC supports OTA updates for nodes that have an OTA ZCL cluster. The OTA mechanism is based off the existing GSDK, OTA-Server plugin. For more information, see <a href="https://www.silabs.com/documents/public/application-notes/an728-ota-client-server-setup.pdf">Silicon Labs' OTA Server-Client Application Note</a>.</p>
<p>NOTE: It is expected that a device will have a bootloader to properly support OTA updates. See <a href="https://www.silabs.com/documents/public/user-guides&gt; ug103-06-fundamentals-bootloading.pdf">Silicon Labs' Bootloader User Guide</a> for more details.</p>
<h2><a class="anchor" id="autotoc_md59"></a>
Zigbee Sleepy End Device Support</h2>
<p>ZigPC handles sleepy end device (SED) communications with the use of the ZCL PollControl server functionality available on the SED. After the SED is interviewed by ZigPC, ZCL messages sent to SED will be stored until the SED PollControl server sends ZigPC a PollControl/CheckIn message. ZigPC will send a PollControl/CheckInrResponse as a reply to transition SED into fast-polling mode. This will allow ZigPC to unload/send any queued messages to the SED.</p>
<h2><a class="anchor" id="autotoc_md60"></a>
Protocol Controller Diagnostics</h2>
<p>ZigPC publishing information related to the host process and NCP information to provide usage statistics to customers. The following metrics are being published currently:</p>
<ul>
<li>System uptime</li>
<li>System CPU load average</li>
<li>Process CPU usage</li>
<li>Process memory usage</li>
<li>Zigbee stack counters</li>
</ul>
<p>UCL topics used:</p>
<ul>
<li>Publishing supported diagnostic metrics: <code>ucl/by-unid/&lt;DEVICE_UNID&gt;/ProtocolController/SystemHealth/SupportedMetrics</code></li>
<li>Subscribing to metric requests: <code>ucl/by-unid/&lt;DEVICE_UNID&gt;/ProtocolController/SystemHealth/Request</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md61"></a>
Updating NCP Firmware</h2>
<p>The Zigbee Protocol Controller has the capability of updating the NCP radio it uses. In the configuration (either YAML file or command line argument, see configuration section for details), enable the "--zigpc.ncp_update" flag and set the "--zigpc.ncp_firmware_path" appropriately. The Protocol Controller will startup and automatically update the NCP with specified firmware. Run zigpc in debug mode to show progress updates.</p>
<p><br  />
<br  />
</p>
<h1><a class="anchor" id="autotoc_md62"></a>
Getting Started with Including Zigbee 3.0 Device to ZigPC</h1>
<p>For the following example, the UNID addresses used are as follows:</p>
<p><b>ZigPC Gateway UNID: zb-AAAAAAAAAAAAAAAA</b></p>
<p><b>Zigbee Device UNID: zb-0102030405060708</b></p>
<p>There are 3 command-lines terminals used in the following steps:</p>
<ol type="1">
<li>Non-ARM Host prompt: Host&gt; (used in Simplicity Commander instructions)</li>
<li>Raspberry Pi prompt: RaspberryPi&gt;</li>
<li>Zigbee Device EmberCLI prompt: Z3Device&gt;</li>
</ol>
<p>OPTIONAL: To see all messages sent to the broker, follow the steps to download and install the <a href="https://mqtt-explorer.com/">MQTT Explorer tool</a>. After it is run on the host machine, connect to the MQTT broker on the Raspberry Pi.</p>
<p>To perform the below steps using the Unify Dev GUI tool, see Dev GUI User Guide.</p>
<h2><a class="anchor" id="autotoc_md63"></a>
Adding Zigbee Device to the ZigPC Network via Install-Code Method</h2>
<p>NOTE: The following steps use the command line interface (CLI) exposed by Simplicity Commander stand-alone tool.</p>
<ol type="1">
<li>Create a random HEX sequence of 6,8,12, or 16 bytes (12, 16, 24, 32 characters respectively) and put it in a file containing the following text: <code>Install Code: &lt;RANDOM_HEX_SEQUENCE&gt;</code></li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">Host&gt; cat /tmp/install-code.txt:</div>
<div class="line"> </div>
<div class="line">Install Code: F64C3E6D196569CE4F2000A40069B534</div>
</div><!-- fragment --><ol type="1">
<li>Connect the Zigbee device to your host machine via USB.</li>
<li>Use the Simplicity Commander CLI to flash the Install code to the Zigbee Device:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">Host&gt; commander flash --tokengroup znet --tokenfile /tmp/install-code.txt --device efr32mg12p</div>
</div><!-- fragment --><ol type="1">
<li>Validate the install code is present and extract the CRC corresponding to the install code by running the following command:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">Host&gt; commander tokendump –-tokengroup znet –-device efr32mg12p</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ...</div>
<div class="line"># # MFG_EMBER_EUI_64              : 0807060504030201       &lt;-- NOTE: This is in Little Endian</div>
<div class="line"># ...</div>
<div class="line"># #&#39;MFG_INSTALLATION_CODE (Smart Energy Install Code)&#39; token group</div>
<div class="line"># # Install Code Flags : 0x0006</div>
<div class="line"># Install Code       : F64C3E6D196569CE4F2000A40069B534    &lt;-- NOTE: This is in Big Endian</div>
<div class="line"># # CRC                : 0x7646                            &lt;-- NOTE: This is in Little Endian</div>
</div><!-- fragment --><blockquote class="doxtable">
<p><em>NOTE: Ensure ZigPC is running by this step.</em> </p>
</blockquote>
<ol type="1">
<li><p class="startli">Format the SmartStart DSK using the Z3Device's EUI64, install code, and install code CRC.</p><ul>
<li>Example EUI64 in big endian = <code>01-02-03-04-05-06-07-08</code></li>
<li>Install code in big endian = <code>F6-4C-3E-6D-19-65-69-CE-4F-20-00-A4-00-69-B5-34</code></li>
<li>Install code CRC big endian = <code>46-76</code></li>
<li>DSK combining above information = <code>01-02-03-04-05-06-07-08-F6-4C-3E-6D-19-65-69-CE-4F-20-00-A4-00-69-B5-34-46-76</code></li>
</ul>
<p class="startli">NOTE: Ensure the EUI64 used above corresponds to the device that is joining, not the example EUI64 used as an example`.</p>
</li>
<li>Access the Zigbee device EmberCLI using Studio or a serial terminal to perform cleanup of the device state.</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">Z3Device&gt; plugin reporting clear</div>
<div class="line">Z3Device&gt; plugin groups clear</div>
<div class="line">Z3Device&gt; network leave</div>
<div class="line">Z3Device&gt; keys clear</div>
</div><!-- fragment --><p>NOTE: Ensure that Z3Device is not part of the network by entering the <code>info</code> command and seeing <code>panID [0x0000]</code> and <code>nodeID [0xFFFE]</code> in the output:</p>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">Z3Device&gt; info</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># MFG String:</div>
<div class="line"># AppBuilder MFG Code: 0x1002</div>
<div class="line"># node [(&gt;)0102030405060708] chan [0] pwr [0]</div>
<div class="line"># panID [0x0000] nodeID [0xFFFE] xpan [0x(&gt;)0000000000000000]</div>
<div class="line"># parentID [0x0000] parentRssi [0]</div>
<div class="line"># ...</div>
<div class="line"># ...</div>
</div><!-- fragment --><ol type="1">
<li>Validate that a new MQTT topic has been published showing the Protocol Controller Network Management state as <code>idle</code>:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_sub -h 0.0.0.0 -p 1883 -t &#39;ucl/by-unid/+/ProtocolController/NetworkManagement&#39;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ucl/by-unid/zb-AAAAAAAAAAAAAAAA/ProtocolController/NetworkManagement {&quot;State&quot;: &quot;idle&quot;, &quot;SupportedStateList&quot;: [&quot;add node&quot;, &quot;remove node&quot;], &quot;RequestedStateParameters&quot;: []}</div>
</div><!-- fragment --><p>in the output above, the ZigPC Gateway UNID can be seen from the topic as <code>zb-AAAAAAAAAAAAAAAA</code></p>
<p><b>Dev GUI Method</b>: Go to the Nodes tab to see the Protocol Controller UNID and state.</p>
<p><img src="doc/assets/user_guide-devgui-nodes-init.png" alt="" class="inline"/></p>
<ol type="1">
<li><p class="startli">Use the Mosquitto publish tool to add a SmartStart entry using the DSK created above.</p>
<p class="startli">OPTIONAL: you can also specify the EUI64 of the ZigPC Gateway NCP (see User Manual below) in the "ProtocolControllerUnid" field:</p>
</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_pub -h 0.0.0.0 -p 1883 -t &#39;ucl/SmartStart/List/Update&#39; -m &#39;{&quot;DSK&quot;:&quot;01-02-03-04-05-06-07-08-F6-4C-3E-6D-19-65-69-CE-4F-20-00-A4-00-69-B5-34-46-76&quot;,&quot;Include&quot;:true,&quot;ProtocolControllerUnid&quot;:&quot;&quot;,&quot;Unid&quot;:&quot;&quot;}&#39;</div>
</div><!-- fragment --><p><b>Dev GUI Method</b>: Go to the SmartStart tab and click on the "Add" key</p>
<p><img src="doc/assets/user_guide-devgui-smartstart-new.png" alt="" class="inline"/></p>
<p><b>Dev GUI Method</b>: Fill in the DSK in the entry.</p>
<p><img src="doc/assets/user_guide-devgui-smartstart-dsk-add.png" alt="" class="inline"/></p>
<ol type="1">
<li>Once ZigPC detects the new SmartStart entry, it will open the network to permit the Z3Device to join using the install code configured.</li>
<li>In the Z3Device, start the Network Steering plugin process by entering <code>plugin network-steering start 0</code> on the Z3Device Ember CLI:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">Z3Device&gt; plugin network-steering start 0</div>
</div><!-- fragment --><ol type="1">
<li>Z3Device should join the ZigPC network and assign a UNID using the following format: <code>zb-&lt;Z3DEVICE_EUI64_BE&gt;</code>.</li>
</ol>
<div class="fragment"><div class="line">## Sample format ##</div>
<div class="line"># Z3Device EUI64(BE): 0102030405060708</div>
<div class="line"># Z3Device UNID: zb-0102030405060708</div>
</div><!-- fragment --><ol type="1">
<li>Validate that the UNID has been assigned by checking the Unify SmartStart list using the Mosquitto subscribe tool:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_sub -h 0.0.0.0 -p 1883 -W 1 -v -t &#39;ucl/SmartStart/List&#39;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ucl/SmartStart/List { &quot;value&quot;: [{&quot;DSK&quot;:&quot;01-02-03-04-05-06-07-08-F6-4C-3E-6D-19-65-69-CE-4F-20-00-A4-00-69-B5-34-46-76&quot;,&quot;Include&quot;:true,&quot;ProtocolControllerUnid&quot;:&quot;&quot;,&quot;Unid&quot;:&quot;zb-0102030405060708&quot;}] }</div>
</div><!-- fragment --><p>As seen, the Device UNID is "zb-0102030405060708".</p>
<p><b>Dev GUI Method</b>: Go to the SmartStart tab and see the updated UNID field.</p>
<p><img src="doc/assets/user_guide-devgui-smartstart-dsk-used.png" alt="" class="inline"/></p>
<ol type="1">
<li>Validate that the ZigPC NetworkManagement state has transitioned back to idle (previous MQTT messages would have shown the NetworkManagement state has transitioned from "idle" -&gt; "add node" -&gt; "node interview" -&gt; "idle"):</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_sub -h 0.0.0.0 -p 1883 -t &#39;ucl/by-unid/+/ProtocolController/NetworkManagement&#39;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ucl/by-unid/zb-AAAAAAAAAAAAAAAA/ProtocolController/NetworkManagement {&quot;State&quot;: &quot;idle&quot;, &quot;SupportedStateList&quot;: [&quot;add node&quot;, &quot;remove node&quot;, &quot;node interview&quot;], &quot;RequestedStateParameters&quot;: []}</div>
</div><!-- fragment --><ol type="1">
<li>Validate that a new MQTT topic has been published showing Z3Device is online and functional:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_sub -h 0.0.0.0 -p 1883 -W 1 -v -t &#39;ucl/by-unid/zb-0102030405060708/State&#39;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/State { &quot;Security&quot;: &quot;Zigbee Z3.0&quot;, &quot;MaximumCommandDelay&quot;: &quot;1&quot;, &quot;NetworkStatus&quot;: &quot;Online functional&quot; }</div>
</div><!-- fragment --><p><b>Dev GUI Method</b>: Go to the Nodes tab and see the updated Z3Device entry.</p>
<p><img src="doc/assets/user_guide-devgui-nodes-included.png" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md64"></a>
Adding Zigbee Device to the ZigPC Network using Well-Known Key</h2>
<p>NOTE: The following steps use the command line interface (CLI) exposed by Simplicity Commander stand-alone tool.</p>
<ol type="1">
<li>Configure and run ZigPC to allow accepting well-known key based joins:</li>
</ol>
<ul>
<li>Using CLI with argument <code>--zigpc.tc_use_well_known_key true</code></li>
<li>Using system service configuration in <code>etc/uic/uic.cfg</code>:</li>
</ul>
<div class="fragment"><div class="line">zigpc:</div>
<div class="line">  ...</div>
<div class="line">  tc_use_well_known_key: true</div>
</div><!-- fragment --><ol type="1">
<li>Validate the following MQTT topic has been published showing the Protocol Controller Network Management state as <code>idle</code>:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_sub -h 0.0.0.0 -p 1883 -t &#39;ucl/by-unid/+/ProtocolController/NetworkManagement&#39;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ucl/by-unid/zb-AAAAAAAAAAAAAAAA/ProtocolController/NetworkManagement {&quot;State&quot;: &quot;idle&quot;, &quot;SupportedStateList&quot;: [&quot;add node&quot;, &quot;remove node&quot;], &quot;RequestedStateParameters&quot;: []}</div>
</div><!-- fragment --><p>in the output above, the ZigPC Gateway UNID can be seen from the topic as <code>zb-AAAAAAAAAAAAAAAA</code></p>
<p><b>Dev GUI Method</b>: Go to the Nodes tab to see the Protocol Controller UNID and state.</p>
<p><img src="doc/assets/user_guide-devgui-nodes-init.png" alt="" class="inline"/></p>
<ol type="1">
<li>Use the Mosquitto publish tool to request a Network Management state change to <code>add node</code>:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_pub -h 0.0.0.0 -p 1883 -t &#39;ucl/by-unid/zb-AAAAAAAAAAAAAAAA/ProtocolController/NetworkManagement/Write&#39; -m &#39;{&quot;State&quot;: &quot;add node&quot;}&#39;</div>
</div><!-- fragment --><p><b>Dev GUI Method</b>: Go to the Nodes tab and click on the "States" dropdown and select the "add node" item.</p>
<p><img src="doc/assets/user_guide-devgui-netmgmt-add-node.png" alt="" class="inline"/></p>
<p>ZigPC will now open the network to permit the Z3Device to join using the well-known key.</p>
<ol type="1">
<li>In the Z3Device, start the Network Steering plugin process by entering <code>plugin network-steering start 0</code> on the Z3Device Ember CLI:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">Z3Device&gt; plugin network-steering start 0</div>
</div><!-- fragment --><ol type="1">
<li>Z3Device should join the ZigPC network and assign a UNID using the following format: <code>zb-&lt;Z3DEVICE_EUI64_BE&gt;</code>.</li>
</ol>
<div class="fragment"><div class="line">## Sample format ##</div>
<div class="line"># Z3Device EUI64(BE): 0102030405060708</div>
<div class="line"># Z3Device UNID: zb-0102030405060708</div>
</div><!-- fragment --><ol type="1">
<li>Validate that the ZigPC NetworkManagement state has transitioned back to idle (previous MQTT messages would have shown the NetworkManagement state has transitioned from "idle" -&gt; "add node" -&gt; "node interview" -&gt; "idle"):</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_sub -h 0.0.0.0 -p 1883 -t &#39;ucl/by-unid/+/ProtocolController/NetworkManagement&#39;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ucl/by-unid/zb-AAAAAAAAAAAAAAAA/ProtocolController/NetworkManagement {&quot;State&quot;: &quot;idle&quot;, &quot;SupportedStateList&quot;: [&quot;add node&quot;, &quot;remove node&quot;, &quot;node interview&quot;], &quot;RequestedStateParameters&quot;: []}</div>
</div><!-- fragment --><ol type="1">
<li>Validate that a new MQTT topic has been published showing Z3Device is online and functional:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_sub -h 0.0.0.0 -p 1883 -W 1 -v -t &#39;ucl/by-unid/zb-0102030405060708/State&#39;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/State { &quot;Security&quot;: &quot;Zigbee Z3.0&quot;, &quot;MaximumCommandDelay&quot;: &quot;1&quot;, &quot;NetworkStatus&quot;: &quot;Online functional&quot; }</div>
</div><!-- fragment --><p><b>Dev GUI Method</b>: Go to the Nodes tab and see the updated Z3Device entry.</p>
<p><img src="doc/assets/user_guide-devgui-nodes-included.png" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md65"></a>
Discovering UCL Cluster Command Support for Z3Device</h2>
<p>NOTE: The Zigbee device must be added using the SmartStart addition process discussed above. NOTE: ZigPC will publish the UCL cluster command support under for all endpoints discovered in the interview process.</p>
<ol type="1">
<li>Subscribe to the UCL cluster command topic space under a Z3Device endpoint: NOTE: Endpoint 1 (ep1) chosen for this example. Other endpoint support will be published based on device discovery</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_sub -h 0.0.0.0 -p 1883 -W 1 -v -t &#39;ucl/by-unid/zb-0102030405060708/ep1/+/SupportedCommands&#39;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/OnOff/SupportedCommands</div>
<div class="line"># {&quot;value&quot;: [&quot;Off&quot;,&quot;On&quot;,&quot;Toggle&quot;,&quot;OffWithEffect&quot;,&quot;OnWithRecallGlobalScene&quot;,&quot;OnWithTimedOff&quot;,&quot;WriteAttributes&quot;,&quot;ForceReadAttributes&quot;]}</div>
<div class="line">#</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/Level/SupportedCommands</div>
<div class="line"># {&quot;value&quot;: [&quot;MoveToLevel&quot;,&quot;Move&quot;,&quot;Step&quot;,&quot;Stop&quot;,&quot;MoveToLevelWithOnOff&quot;,&quot;MoveWithOnOff&quot;,&quot;StepWithOnOff&quot;,&quot;StopWithOnOff&quot;,&quot;MoveToClosestFrequency&quot;,&quot;WriteAttributes&quot;,&quot;ForceReadAttributes&quot;]}</div>
<div class="line">#</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/Identify/SupportedCommands</div>
<div class="line"># {&quot;value&quot;: [&quot;Identify&quot;,&quot;IdentifyQuery&quot;,&quot;TriggerEffect&quot;,&quot;WriteAttributes&quot;,&quot;ForceReadAttributes&quot;]}</div>
<div class="line">#</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/Groups/SupportedCommands</div>
<div class="line"># {&quot;value&quot;: [&quot;AddGroup&quot;,&quot;ViewGroup&quot;,&quot;GetGroupMembership&quot;,&quot;RemoveGroup&quot;,&quot;RemoveAllGroups&quot;,&quot;AddGroupIfIdentifying&quot;,&quot;WriteAttributes&quot;,&quot;ForceReadAttributes&quot;]}</div>
</div><!-- fragment --><p><b>Dev GUI Method</b>: Go to the Nodes tab and see <code>Type</code> column to see the supported clusters.</p>
<p><img src="doc/assets/user_guide-devgui-nodes-included.png" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md66"></a>
Discovering UCL Cluster Attribute Updates for Z3Device</h2>
<p>NOTE: The Zigbee device must be added using the SmartStart addition process discussed above. NOTE: ZigPC will publish the UCL cluster support under for all endpoints discovered in the interview process.</p>
<ol type="1">
<li>Subscribe to the UCL cluster attribute topic space under one of the Z3Device endpoints: NOTE: Endpoint 1 (ep1) chosen for this example. Other endpoint support will be published based on device discovery.</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_sub -h 0.0.0.0 -p 1883 -W 1 -v -t &#39;ucl/by-unid/zb-0102030405060708/ep1/+/Attributes/#&#39;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/OnOff/Attributes/GlobalSceneControl/Reported { &quot;value&quot;: true }</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/OnOff/Attributes/OnOff/Reported { &quot;value&quot;: false }</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/OnOff/Attributes/OnTime/Reported { &quot;value&quot;: 0 }</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/OnOff/Attributes/OffWaitTime/Reported { &quot;value&quot;: 0 }</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/OnOff/Attributes/StartUpOnOff/Reported { &quot;value&quot;: &quot;SetOnOffTo0&quot; }</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/OnOff/Attributes/ClusterRevision/Reported {&quot;value&quot;: 2}</div>
<div class="line">#</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/Level/Attributes/CurrentLevel/Reported { &quot;value&quot;: 0 }</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/Level/Attributes/RemainingTime/Reported { &quot;value&quot;: 0 }</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/Level/Attributes/StartUpCurrentLevel/Reported { &quot;value&quot;: 0 }</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/Level/Attributes/ClusterRevision/Reported {&quot;value&quot;: 2}</div>
<div class="line"># ...</div>
<div class="line"># ...</div>
</div><!-- fragment --><p><b>Dev GUI Method</b>: Go to a specific cluster tab (i.e. OnOff) see the main attribute <code>State</code> column.</p>
<p><img src="doc/assets/user_guide-devgui-onoff-discovery.png" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md67"></a>
Sending a UCL Cluster Command to Z3Device to see Attribute Update</h2>
<p>The UCL command format translates 1:1 to ZCL messages that is recognized by ZCL compliant Zigbee devices. To know the exact format of the UCL command, see the Unify specification and the DotDot specification.</p>
<ol type="1">
<li>See the supported commands for a UCL cluster. For this exercise, the endpoint 1, OnOff cluster will be selected.</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_sub -h 0.0.0.0 -p 1883 -W 1 -v -t &#39;ucl/by-unid/zb-0102030405060708/ep1/OnOff/SupportedCommands&#39;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/OnOff/SupportedCommands {&quot;value&quot;: [&quot;Off&quot;,&quot;On&quot;,&quot;Toggle&quot;,&quot;OffWithEffect&quot;,&quot;OnWithRecallGlobalScene&quot;,&quot;OnWithTimedOff&quot;,&quot;WriteAttributes&quot;,&quot;ForceReadAttributes&quot;]}</div>
</div><!-- fragment --><p>The commands can be send to the Z3Device/ep1/OnOff cluster: <code>Off, On, Toggle, OffWithEffect, OnWithRecallGlobalScene, OnWithTimedOff, WriteAttributes, ForceReadAttributes</code></p>
<ol type="1">
<li>Publish a UCL command to send to the Z3Device endpoint's OnOff cluster.</li>
</ol>
<div class="fragment"><div class="line">## sample output based on choosing to send the OnOff/Toggle command ##</div>
<div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_pub -h 0.0.0.0 -p 1883 -t &#39;ucl/by-unid/zb-0102030405060708/ep1/OnOff/Commands/Toggle&#39; -m &#39;{}&#39;</div>
</div><!-- fragment --><p><b>Dev GUI Method</b>: Go to the OnOff tab and click on the <code>Toggle</code> Command on the ep1 row.</p>
<ol type="1">
<li>On the Z3Device device, notice that a ZCL message has been received:</li>
</ol>
<div class="fragment"><div class="line">Z3Device&gt;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># T00000000:RX len 3, ep 01, clus 0x0006 (On/off) FC 01 seq 1A cmd 02 payload[]</div>
</div><!-- fragment --><ol type="1">
<li>Subscribe to the UCL OnOff Attribute in the OnOff cluster to see the updated reported state:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_sub -h 0.0.0.0 -p 1883 -W 1 -v -t &#39;ucl/by-unid/zb-0102030405060708/ep1/OnOff/Attributes/OnOff/Reported&#39;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/OnOff/Attributes/OnOff/Reported { &quot;value&quot;: true }</div>
</div><!-- fragment --><p><b>Dev GUI Method</b>: Go to the OnOff tab and see the OnOff <code>State</code> icon is active.</p>
<p><img src="doc/assets/user_guide-devgui-onoff-toggle.png" alt="" class="inline"/></p>
<ol type="1">
<li>Retry the same UCL command to send to the Z3Device endpoint's OnOff cluster.</li>
</ol>
<div class="fragment"><div class="line">## sample output based on choosing to send the OnOff/Toggle command ##</div>
<div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_pub -h 0.0.0.0 -p 1883 -t &#39;ucl/by-unid/zb-0102030405060708/ep1/OnOff/Commands/Toggle&#39; -m &#39;{}&#39;</div>
</div><!-- fragment --><ol type="1">
<li>On the Z3Device device, notice that a ZCL message has been received:</li>
</ol>
<div class="fragment"><div class="line">Z3Device&gt;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># T00000000:RX len 3, ep 01, clus 0x0006 (On/off) FC 01 seq 1B cmd 02 payload[]</div>
</div><!-- fragment --><ol type="1">
<li>Subscribe to the UCL OnOff Attribute in the OnOff cluster to see the updated reported state:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_sub -h 0.0.0.0 -p 1883 -W 1 -v -t &#39;ucl/by-unid/zb-0102030405060708/ep1/OnOff/Attributes/OnOff/Reported&#39;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ucl/by-unid/zb-0102030405060708/ep1/OnOff/Attributes/OnOff/Reported { &quot;value&quot;: false }</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md68"></a>
Removing a Device Already in the ZigPC Network</h2>
<p>NOTE: The Zigbee device must be added using the SmartStart addition process discussed above.</p>
<ol type="1">
<li>Send a Network Management state change to start removing a node:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_pub -h 0.0.0.0 -p 1883 -t &#39;ucl/by-unid/zb-AAAAAAAAAAAAAAAA/ProtocolController/NetworkManagement/Write&#39; -m &#39;{&quot;State&quot;: &quot;remove node&quot;}&#39;</div>
</div><!-- fragment --><ol type="1">
<li>ZigPC will try to perform a state change. If successful, the following message will be published:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_sub -h 0.0.0.0 -p 1883 -t &#39;ucl/by-unid/zb-AAAAAAAAAAAAAAAA/ProtocolController/NetworkManagement&#39;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ucl/by-unid/zb-AAAAAAAAAAAAAAAA/ProtocolController/NetworkManagement {&quot;State&quot;: &quot;remove node&quot;, &quot;SupportedStateList&quot;: [&quot;add node&quot;, &quot;remove node&quot;, &quot;node interview&quot;], &quot;RequestedStateParameters&quot;: [&quot;Unid&quot;]}</div>
</div><!-- fragment --><p>As seen above, ZigPC requests that the UNID parameter should be passed in.</p>
<ol type="1">
<li>Send the UNID of the Z3Device to remove:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_pub -h 0.0.0.0 -p 1883 -t &#39;ucl/by-unid/zb-AAAAAAAAAAAAAAAA/ProtocolController/NetworkManagement/Write&#39; -m &#39;{&quot;State&quot;: &quot;remove node&quot;, &quot;StateParameters&quot;: {&quot;Unid&quot;: &quot;zb-0102030405060708&quot;}}&#39;</div>
</div><!-- fragment --><ol type="1">
<li>Validate that the Z3Device has left the network by entering <code>info</code> on the Ember CLI and noticing a nodeID of 0xFFFE:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">Z3Device&gt; info</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># MFG String:</div>
<div class="line"># AppBuilder MFG Code: 0x1002</div>
<div class="line"># node [(&gt;)0102030405060708] chan [0] pwr [0]</div>
<div class="line"># panID [0x0000] nodeID [0xFFFE] xpan [0x(&gt;)0000000000000000]</div>
<div class="line"># parentID [0x0000] parentRssi [0]</div>
<div class="line"># ...</div>
</div><!-- fragment --><ol type="1">
<li>Validate that the NetworkManagement topic has shown the state transition from "remove node" to "idle":</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_sub -h 0.0.0.0 -p 1883 -t &#39;ucl/by-unid/+/ProtocolController/NetworkManagement&#39;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ucl/by-unid/zb-AAAAAAAAAAAAAAAA/ProtocolController/NetworkManagement {&quot;State&quot;: &quot;idle&quot;, &quot;SupportedStateList&quot;: [&quot;add node&quot;, &quot;remove node&quot;, &quot;node interview&quot;], &quot;RequestedStateParameters&quot;: []}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md69"></a>
Updating Zigbee Device Firmware already on the ZigPC Network</h2>
<p>To initialize an OTA update, you need the following:</p>
<ul>
<li>A working end-device with a ZCL OTA client cluster enabled.</li>
<li>A valid firmware file to upload to the device - refer to the application note above.</li>
<li>Sufficient storage space on both host and end device for the firmware image.</li>
<li>(Optional) An ota-files directory created in the location where the ZigPC will be run.</li>
</ul>
<h3><a class="anchor" id="autotoc_md70"></a>
Instructions on how to start an OTA update</h3>
<ol type="1">
<li>Run the Zigbee Protocol Controller, as specified above in this document</li>
<li>Verify that the 'ota-files' directory exists. This path can be manually passed in If this folder was not created by the user, the Zigbee Protocol Controller should create it at startup.</li>
<li>Add a Zigbee node, as described above in [Adding Z3Light Device to the ZigPC Network]</li>
<li>Start the Unify Image Provider application. See Unify Image Provider User Guide</li>
<li><p class="startli">Add the firmware image to the image-provider's specified folder. Update the images.json file with the firmware information.</p>
<p class="startli"><em>NOTE: For this version of the Zigbee Protocol Controller, the UIID should be set to the UNID of the node that should be updated. Future releases will allow for a more involved UIID, which can reflect version and other information.</em></p>
<p class="startli"><em>NOTE: The image-provider's images.json file needs to be updated <b>after</b> ZigPC is running to ensure that ZigPC receives the "image announce" message. Updating the images.json file automatically triggers this process.</em></p>
</li>
</ol>
<h3><a class="anchor" id="autotoc_md71"></a>
Once the Unify Image Provider recognizes changes to images.json, the following actions will occur</h3>
<ol type="1">
<li>ZigPC will recognize any supported OTA image metadata and the image should be automatically copied to the 'ota-files' directory.</li>
<li><p class="startli">The Silicon Labs' OTA-Client plugin on the Zigbee node should periodically poll ZigPC for new images (based on the "OTA Client Query Delay").</p>
<p class="startli"><em>NOTE: If there is access to the CLI on the node, the command '<code>plugin ota-client request-image</code>' can manually send this request to ZigPC.</em></p>
</li>
<li>The OTA image transfer from ZigPC to the Zigbee node should start. Do not interrupt the OTA process to ensure proper operation. Debug messages on the ZigPC can be enabled at startup with the option '-d', which can help verify that the messages are being sent.</li>
<li>After the OTA image upload and installation is complete, the new firmware version running on the Zigbee node can be verified. The OTA process is now complete.</li>
</ol>
<h2><a class="anchor" id="autotoc_md72"></a>
Retrieving Diagnostic information from ZigPC</h2>
<p>ZigPC has exposed the <code>ProtocolController/SystemHealth</code> topic space to enable the publishing of information related to the ZigPC system, process, and Zigbee stack.</p>
<p>The following metrics are available:</p>
<ul>
<li>Uptime: The amount of seconds the system has been online.</li>
<li>CpuLoadAverage: The system CPU load average.</li>
<li>MemUsePercent: The percent memory use of the ZigPC process.</li>
<li>Counters: The Zigbee stack counters information.</li>
</ul>
<h3><a class="anchor" id="autotoc_md73"></a>
Steps to enable this behaviour</h3>
<ol type="1">
<li>Retrieve the metrics supported by the protocol controller diagnostics topic space.</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_sub -h 0.0.0.0 -p 1883 -t &#39;ucl/by-unid/zb-AAAAAAAAAAAAAAAA/ProtocolController/SystemHealth/SupportedMetrics&#39;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ucl/by-unid/zb-AAAAAAAAAAAAAAAA/ProtocolController/SystemHealth/SupportedMetrics {&quot;value&quot;: [&quot;Uptime&quot;, &quot;CpuLoadAverage&quot;, &quot;MemUsePercent&quot;, &quot;Counters&quot;]}</div>
</div><!-- fragment --><ol type="1">
<li>Enable a metric using the <code>Request</code> subtopic:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_pub -h 0.0.0.0 -p 1883 -t &#39;ucl/by-unid/zb-AAAAAAAAAAAAAAAA/ProtocolController/SystemHealth/Request&#39; -m &#39;{&quot;value&quot;: [&quot;MemUsePercent&quot;]}&#39;</div>
</div><!-- fragment --><ol type="1">
<li>Validate metric requested being updated regularly:</li>
</ol>
<div class="fragment"><div class="line">## command ##</div>
<div class="line">RaspberryPi&gt; mosquitto_sub -h 0.0.0.0 -p 1883 -t &#39;ucl/by-unid/zb-AAAAAAAAAAAAAAAA/ProtocolController/SystemHealth/MemUsePercent&#39;</div>
<div class="line"> </div>
<div class="line">## sample output ##</div>
<div class="line"># ucl/by-unid/zb-AAAAAAAAAAAAAAAA/ProtocolController/SystemHealth/MemUsePercent {&quot;value&quot;: 0.12}</div>
</div><!-- fragment --><p><br  />
<br  />
</p>
<h1><a class="anchor" id="autotoc_md74"></a>
Technical Specifications</h1>
<h2><a class="anchor" id="autotoc_md75"></a>
Device UNID Format</h2>
<p>ZigPC uses the following format for the UNID: zb-&lt;EUI64-IN-BIG-ENDIAN&gt;</p>
<p>where "zb-" is the current fixed prefix (subject to be configurable in later releases)</p>
<p>For example, the following Zigbee device having a EUI64 of 01 23 45 67 89 AB CD EF has the following device UNID <code>zb-0123456789ABCDEF</code>.</p>
<h2><a class="anchor" id="autotoc_md76"></a>
Recognized SmartStart DSK Format</h2>
<p>ZigPC supports the following SmartStart Device-Specific Key (DSK) format:</p>
<p><code>&lt;NODE_EUI64&gt;</code>-<code>&lt;Z3_INSTALL_CODE&gt;</code>-<code>&lt;Z3_INSTALL_CODE_CRC&gt;</code></p>
<ul>
<li>Both the EUI64 and Install code values should be in big endian</li>
<li>The EUI64 identifier is placed first since it has a fixed length</li>
<li>Use hyphens ("-") to separate each group of 2 hexadecimal characters</li>
<li>This accommodates the variable Z3 Install code lengths noted above</li>
<li>The maximum length of the DSK should be 77 characters in ASCII representation (52 characters without dashes)</li>
</ul>
<p>Examples of Supported ZigPC DSK:</p>
<ul>
<li>for <b>8-byte</b> Z3 Install code variant: <code>00-11-22-33-44-55-66-77-AA-BB-CC-DD-EE-FF-00-11-88-99</code></li>
<li>for <b>16-byte</b> Z3 Install code variant: <code>00-11-22-33-44-55-66-77-AA-BB-CC-DD-EE-FF-00-11-22-33-44-55-66-77-88-99-12-34</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md77"></a>
Zigbee Device Support</h2>
<p>ZigPC should have a Zigbee NCP attached via the serial UART connection.</p>
<p>EFR32MG1X or EFR32MG2X are the supported NCP Radios.</p>
<p>NCP Image supported by ZigPC from GSDK v4.1:</p>
<ul>
<li>ncp-uart-hw</li>
<li>ncp-uart-sw</li>
</ul>
<p>ZigPC currently uses the following functionality using Gecko SDK v4.0:</p>
<ul>
<li>Communication with Zigbee NCP using EZSP over Serial (UART)</li>
<li>Network formation as a Zigbee Trust Center</li>
<li>Device addition using Z3 Install Code Method</li>
<li>Usage of the Device Table plugin to track nodes on the PAN</li>
<li>Reporting plugin</li>
</ul>
<p>Device types types:</p>
<ul>
<li>Non Sleepy Devices (Router + End devices)</li>
<li>Sleepy End Devices</li>
</ul>
<p>ZCL cluster types supported by ZigPC for attribute updates and command relays:</p>
<ul>
<li>(0x0003) Identify</li>
<li>(0x0004) Groups</li>
<li>(0x0006) OnOff</li>
<li>(0x0008) Level</li>
<li>(0x0101) DoorLock</li>
<li>(0x0201) Thermostat</li>
<li>(0x0300) ColorControl</li>
<li>(0x0406) OccupancySensing</li>
</ul>
<h1><a class="anchor" id="autotoc_md78"></a>
Appendix</h1>
<h2><a class="anchor" id="autotoc_md79"></a>
Setting Up the Zigbee NCP Connected to ZigPC</h2>
<p>There are two ways to get the NCP image:</p>
<h3><a class="anchor" id="autotoc_md80"></a>
Using Pre-built NCP FW Images</h3>
<p>A single radio should be designated as a Zigbee Gateway NCP that ZigPC connects to.</p>
<p>The Gecko SDK provides ready-made NCP images available under the demo-applications package.</p>
<h3><a class="anchor" id="autotoc_md81"></a>
Building NCP FW Images Using Studio</h3>
<p>Follow section 2 from the following application note to build a NCP application using the Simplicity Studio IDE: <a href="https://www.silabs.com/documents/public/application-notes/an1010-customized-ncp.pdf">AN1010: Building a Customized NCP Application</a></p>
<h2><a class="anchor" id="autotoc_md82"></a>
Setting Up the Sample Zigbee Z3Light FW Image</h2>
<p>A Zigbee 3.0 Light device FW is used as an example device that can join the ZigPC network.</p>
<p>Follow the instructions in <em>Section 4: Starting an Example Application</em> in <a href="https://www.silabs.com/documents/public/quick-start-guides/qsg106-efr32-zigbee-pro.pdf">QSG106: Zigbee EmberZNet PRO Quick-Start Guide</a> to create a <b>Z3Light</b> Application.</p>
<p>NOTE: before the Appbuilder project generation, ensure the following changes are made:</p>
<ol type="1">
<li>In the <em>Plugins</em> tab, ensure the "Binding Table Size" in the "Binding Table
Library" plugin is bigger is considerable enough to accommodate ZCL groups (uses multicast bindings) and attribute reporting (to allow ZigPC to receive automated attribute updates). For the Z3Light project, this should be at least 16.</li>
</ol>
<div class="fragment"><div class="line">Plugins tab -&gt; Binding Table Library -&gt;    Binding Table Size &gt; 16</div>
</div><!-- fragment --><ol type="1">
<li>[OPTIONAL] In the <em>Plugins</em> tab, ensure the "Reporting Table Size" in the "Reporting" plugin is bigger than the number of attributes supported in each device endpoint cluster. For the Z3Light project, this should be at least 9.</li>
</ol>
<div class="fragment"><div class="line">Plugins tab -&gt; Reporting -&gt;    Reporting Table Size &gt; 9</div>
<div class="line">NOTE: In the Appbuilder project, see EMBER_AF_GENERATED_REPORTING_CONFIG_DEFAULTS_TABLE_SIZE for the recommended minimum size</div>
</div><!-- fragment --><blockquote class="doxtable">
<p><em>NOTE: If the reporting table size is not sufficient to support all attributes, Unify IoT Services will need to use the ForceReadAttributes command to get updated attribute states</em> </p>
</blockquote>
<p>Follow the steps below to create and flash the Zigbee Z3Light Image:</p>
<h2><a class="anchor" id="autotoc_md83"></a>
Flashing Zigbee Devices</h2>
<p>For flashing device firmware onto the Zigbee radios, see <em>Section 4.4: Compiling and Flashing the Application</em> in <a href="https://www.silabs.com/documents/public/quick-start-guides/qsg106-efr32-zigbee-pro.pdf">QSG106: Zigbee EmberZNet PRO Quick-Start Guide</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Sep 21 2022 18:53:44 for Zigbee Protocol Controller by <a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
